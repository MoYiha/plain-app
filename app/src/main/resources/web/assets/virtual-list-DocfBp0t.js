var J=Object.defineProperty;var Q=(t,e,i)=>e in t?J(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;var c=(t,e,i)=>(Q(t,typeof e!="symbol"?e+"":e,i),i);import{d as V,h as T,p,aC as Z,aU as K,cc as ee,aV as P,k as F,cd as te,L as ie,ce as se}from"./index-BxNI00MG.js";const I={FRONT:"FRONT",BEHIND:"BEHIND"},m={INIT:"INIT",FIXED:"FIXED",DYNAMIC:"DYNAMIC"},L=2;class ne{constructor(e,i){c(this,"direction","");c(this,"fixedSizeValue",0);c(this,"sizes",new Map);c(this,"offset",0);c(this,"param",null);c(this,"range",null);c(this,"firstRangeTotalSize",0);c(this,"firstRangeAverageSize",0);c(this,"lastCalcIndex",0);c(this,"callUpdate",null);c(this,"calcType",m.INIT);this.init(e,i)}init(e,i){this.param=e,this.callUpdate=i,this.sizes=new Map,this.firstRangeTotalSize=0,this.firstRangeAverageSize=0,this.lastCalcIndex=0,this.fixedSizeValue=0,this.calcType=m.INIT,this.offset=0,this.direction="",this.range=Object.create(null),e&&this.checkRange(0,e.keeps-1)}destroy(){this.init(null,null)}getRange(){const e=Object.create(null);return e.start=this.range.start,e.end=this.range.end,e.padFront=this.range.padFront,e.padBehind=this.range.padBehind,e}isBehind(){return this.direction===I.BEHIND}isFront(){return this.direction===I.FRONT}getOffset(e){return(e<1?0:this.getIndexOffset(e))+this.param.slotHeaderSize}updateParam(e,i){this.param&&e in this.param&&(e==="uniqueIds"&&this.sizes.forEach((n,a)=>{i.includes(a)||this.sizes.delete(a)}),this.param[e]=i)}saveSize(e,i){this.sizes.set(e,i),this.calcType===m.INIT?(this.fixedSizeValue=i,this.calcType=m.FIXED):this.calcType===m.FIXED&&this.fixedSizeValue!==i&&(this.calcType=m.DYNAMIC,this.fixedSizeValue=0),this.calcType!==m.FIXED&&typeof this.firstRangeTotalSize<"u"&&(this.sizes.size<Math.min(this.param.keeps,this.param.uniqueIds.length)?(this.firstRangeTotalSize=[...this.sizes.values()].reduce((n,a)=>n+a,0),this.firstRangeAverageSize=Math.round(this.firstRangeTotalSize/this.sizes.size)):this.firstRangeTotalSize=void 0)}handleDataSourcesChange(){let e=this.range.start;this.isFront()?e=e-L:this.isBehind()&&(e=e+L),e=Math.max(e,0),this.updateRange(this.range.start,this.getEndByStart(e))}handleSlotSizeChange(){this.handleDataSourcesChange()}handleScroll(e){this.direction=e<this.offset?I.FRONT:I.BEHIND,this.offset=e,this.param&&(this.direction===I.FRONT?this.handleFront():this.direction===I.BEHIND&&this.handleBehind())}handleFront(){const e=this.getScrollOvers();if(e>this.range.start)return;const i=Math.max(e-this.param.buffer,0);this.checkRange(i,this.getEndByStart(i))}handleBehind(){const e=this.getScrollOvers();e<this.range.start+this.param.buffer||this.checkRange(e,this.getEndByStart(e))}getScrollOvers(){const e=this.offset-this.param.slotHeaderSize;if(e<=0)return 0;if(this.isFixedType())return Math.floor(e/this.fixedSizeValue);let i=0,n=0,a=0,l=this.param.uniqueIds.length;for(;i<=l;){if(n=i+Math.floor((l-i)/2),a=this.getIndexOffset(n),a===e)return n;a<e?i=n+1:a>e&&(l=n-1)}return i>0?--i:0}getIndexOffset(e){if(!e)return 0;let i=0,n=0;for(let a=0;a<e;a++)n=this.sizes.get(this.param.uniqueIds[a])??0,i=i+(typeof n=="number"?n:this.getEstimateSize());return this.lastCalcIndex=Math.max(this.lastCalcIndex,e-1),this.lastCalcIndex=Math.min(this.lastCalcIndex,this.getLastIndex()),i}isFixedType(){return this.calcType===m.FIXED}getLastIndex(){return this.param.uniqueIds.length-1}checkRange(e,i){const n=this.param.keeps;this.param.uniqueIds.length<=n?(e=0,i=this.getLastIndex()):i-e<n-1&&(e=i-n+1),this.range.start!==e&&this.updateRange(e,i)}updateRange(e,i){this.range.start=e,this.range.end=i,this.range.padFront=this.getPadFront(),this.range.padBehind=this.getPadBehind(),this.callUpdate(this.getRange())}getEndByStart(e){const i=e+this.param.keeps-1;return Math.min(i,this.getLastIndex())}getPadFront(){return this.isFixedType()?this.fixedSizeValue*this.range.start:this.getIndexOffset(this.range.start)}getPadBehind(){const e=this.range.end,i=this.getLastIndex();return this.isFixedType()?(i-e)*this.fixedSizeValue:this.lastCalcIndex===i?this.getIndexOffset(i)-this.getIndexOffset(e):(i-e)*this.getEstimateSize()}getEstimateSize(){return this.isFixedType()?this.fixedSizeValue:this.firstRangeAverageSize||this.param.estimateSize}}const ae={dataKey:{type:[String,Function],required:!0},dataSources:{type:Array,required:!0,default:()=>[]},keeps:{type:Number,default:30},estimateSize:{type:Number,default:50},direction:{type:String,default:"vertical"},start:{type:Number,default:0},offset:{type:Number,default:0},topThreshold:{type:Number,default:0},bottomThreshold:{type:Number,default:0},pageMode:{type:Boolean,default:!1}},re={index:{type:Number},event:{type:String},horizontal:{type:Boolean},source:{type:Object},component:{type:Function},uniqueKey:{type:[String,Number]}},oe={event:{type:String},uniqueKey:{type:String},horizontal:{type:Boolean}},w=(t,e,i)=>{let n=null;const a=Z(()=>t.horizontal?"offsetWidth":"offsetHeight"),l=()=>e.value?e.value[a.value]:0,f=()=>{const{event:u,uniqueKey:v,hasInitial:o}=t;i(u,v,l(),o)};K(()=>{typeof ResizeObserver<"u"&&(n=new ResizeObserver(()=>{f()}),e.value&&n.observe(e.value))}),ee(()=>{f()}),P(()=>{n&&(n.disconnect(),n=null)})},le=V({name:"VirtualListItem",props:re,emits:["itemResize"],setup(t,{emit:e}){const i=T(null);return w(t,i,e),()=>{const{component:n,index:a,source:l,uniqueKey:f}=t;return p("div",{key:f,ref:i},[n({index:a,item:l})])}}}),H=V({name:"VirtualListSlot",props:oe,emits:["slotResize"],setup(t,{slots:e,emit:i}){const n=T(null);return w(t,n,i),()=>{var l;const{uniqueKey:a}=t;return p("div",{ref:n,key:a},[(l=e.default)==null?void 0:l.call(e)])}}});function A(t){return typeof t=="function"||Object.prototype.toString.call(t)==="[object Object]"&&!se(t)}var O=function(t){return t.ITEM="itemResize",t.SLOT="slotResize",t}(O||{}),R=function(t){return t.HEADER="thead",t.FOOTER="tfoot",t}(R||{});const ce=V({name:"VirtualList",props:ae,setup(t,{emit:e,slots:i,expose:n}){const a=t.direction==="horizontal",l=a?"scrollLeft":"scrollTop",f=T(null),u=T(),v=T(null);let o;F(()=>t.dataSources.length,()=>{o.updateParam("uniqueIds",q()),o.handleDataSourcesChange()}),F(()=>t.keeps,s=>{o.updateParam("keeps",s),o.handleSlotSizeChange()}),F(()=>t.start,s=>{B(s)}),F(()=>t.offset,s=>z(s));const U=s=>o.sizes.get(s),M=()=>t.pageMode?document.documentElement[l]||document.body[l]:u.value?Math.ceil(u.value[l]):0,b=()=>{const s=a?"clientWidth":"clientHeight";return t.pageMode?document.documentElement[s]||document.body[s]:u.value?Math.ceil(u.value[s]):0},C=()=>{const s=a?"scrollWidth":"scrollHeight";return t.pageMode?document.documentElement[s]||document.body[s]:u.value?Math.ceil(u.value[s]):0},X=(s,r,d,h)=>{e("scroll",h,o.getRange()),o.isFront()&&t.dataSources.length&&s-t.topThreshold<=0?e("totop"):o.isBehind()&&s+r+t.bottomThreshold>=d&&e("tobottom")},N=s=>{const r=M(),d=b(),h=C();r<0||r+d>h+1||!h||(o.handleScroll(r),X(r,d,h,s))},q=()=>{const{dataKey:s,dataSources:r=[]}=t;return r.map(d=>typeof s=="function"?s(d):d[s])},j=s=>{f.value=s},$=()=>{o=new ne({slotHeaderSize:0,slotFooterSize:0,keeps:t.keeps,estimateSize:t.estimateSize,buffer:Math.round(t.keeps/3),uniqueIds:q()},j),f.value=o.getRange()},B=s=>{if(s>=t.dataSources.length-1)D();else{const r=o.getOffset(s);z(r)}},z=s=>{t.pageMode?(document.body[l]=s,document.documentElement[l]=s):u.value&&(u.value[l]=s)},Y=s=>{const r=[],{start:d,end:h}=f.value||{start:0,end:0},{dataSources:E,dataKey:y}=t;for(let g=d;g<=h;g++){const S=E[g];if(S){const x=typeof y=="function"?y(S):S[y];typeof x=="string"||typeof x=="number"?r.push(p(le,{index:g,event:O.ITEM,horizontal:a,uniqueKey:x,source:S,component:s,onItemResize:_},null)):console.warn(`Cannot get the data-key '${y}' from data-sources.`)}else console.warn(`Cannot get the index '${g}' from data-sources.`)}return r},_=(s,r)=>{o.saveSize(s,r),e("resized",s,r)},k=(s,r,d)=>{s===R.HEADER?o.updateParam("slotHeaderSize",r):s===R.FOOTER&&o.updateParam("slotFooterSize",r),d&&o.handleSlotSizeChange()},D=()=>{if(v.value){const s=v.value[a?"offsetLeft":"offsetTop"];z(s),setTimeout(()=>{M()+b()<C()&&D()},3)}},W=()=>{if(u.value){const s=u.value.getBoundingClientRect(),{defaultView:r}=u.value.ownerDocument,d=a?s.left+r.pageXOffset:s.top+r.pageYOffset;o.updateParam("slotHeaderSize",d)}},G=()=>o.sizes.size;return te(()=>{$()}),ie(()=>{z(o.offset)}),K(()=>{t.start?B(t.start):t.offset&&z(t.offset),t.pageMode&&(W(),document.addEventListener("scroll",N,{passive:!1}))}),P(()=>{o.destroy(),t.pageMode&&document.removeEventListener("scroll",N)}),n({scrollToBottom:D,getSizes:G,getSize:U,getOffset:M,getScrollSize:C,getClientSize:b,scrollToOffset:z,scrollToIndex:B}),()=>{let s,r;const{pageMode:d}=t,{padFront:h,padBehind:E}=f.value,y={padding:a?`0px ${E}px 0px ${h}px`:`${h}px 0px ${E}px`},{header:g,footer:S,item:x}=i;return p("div",{ref:u,onScroll:d?void 0:N},[g&&p(H,{class:"header",event:O.SLOT,uniqueKey:R.HEADER,onSlotResize:k},A(s=g())?s:{default:()=>[s]}),p("div",{class:"wrap",style:y},[Y(x)]),S&&p(H,{class:"footer",event:O.SLOT,uniqueKey:R.FOOTER,onSlotResize:k},A(r=S())?r:{default:()=>[r]}),p("div",{ref:v,style:{width:a?"0px":"100%",height:a?"100%":"0px"}},null)])}}});export{ce as V};
