import{d as X,u as Y,g as ee,h as d,s as te,i as ae,l as se,j as S,aZ as ne,at as H,aU as oe,a0 as B,aV as ie,c as r,a as s,O as le,P as ce,t as u,e as N,x as A,y as de,A as h,w as v,p as Q,Q as re,C as ue,b9 as pe,ba as _e,bb as ve,S as me,o as l,m,bc as M,v as he,q as R,am as G,V as K,bd as q,F as fe,G as ye,be,al as Ce,bf as ge,H as ke}from"./index-BxNI00MG.js";import{u as we}from"./markdown-CMfotNJO.js";const Ae=f=>(fe("data-v-4d4db71f"),f=f(),ye(),f),Me={class:"chat-container"},Ie={key:0,class:"date"},Te={class:"chat-title"},$e={class:"name"},xe={class:"time"},Ve={class:"menu-items"},De=["onClick","disabled"],Le={slot:"headline"},Se={key:2,class:"chat-title"},He={class:"name"},Be={class:"time"},Ne=["innerHTML"],Qe={key:0,class:"chat-item replying"},Re={class:"chat-title"},Ge={class:"name"},Ke=["innerHTML"],qe={class:"chat-input",style:{"min-height":"80px"}},Fe=["placeholder","onKeydown"],Ue={class:"btns"},Pe=Ae(()=>s("md-ripple",null,null,-1)),je=X({__name:"AIChatView",setup(f){const F=Y(),{t:U}=ee(),P=re(),c=d(P.params.id),i=d(""),p=d([]),y=d(!1),b=d(""),g=d(""),{app:j,urlTokenKey:E}=te(ae()),I=d(),{render:C}=we(j,E);function k(){return c.value==="create"}function O(e,t){let n=!1;if(t==0)n=!0;else{const o=t>0?p.value[t-1]:null;o!=null&&M(o.createdAt)!==M(e.createdAt)&&(n=!0)}return n}k()||se({handle:async(e,t)=>{if(t)ue(U(t),"error");else{const n=[];n.push({...e.aiChat,md:await C(e.aiChat.content)});for(const o of e.aiChats)n.push({...o,md:await C(o.content)});p.value=n,await H(),x()}},document:pe,variables:()=>({id:c.value,query:`parent_id:${c.value} sort:created_at-asc`}),appApi:!0});const{mutate:T,onDone:Z}=S({document:_e,appApi:!0});function $(){!i.value||y.value||T({id:k()?"":c.value,message:i.value,isMe:!0})}Z(async e=>{var n;const t=e.data.createAIChat;if(t){for(const _ of t)(n=p.value)==null||n.push({..._,md:await C(_.content)});k()&&(c.value=t[0].id,ne(F,`/aichats/${c.value}`)),i.value="",y.value=!y.value,b.value="",g.value='<span class="blinking-cursor"></span>',await H(),x()}});function x(){const e=I.value;e&&(e.scrollTop=e.scrollHeight)}const w=d(""),{mutate:z,loading:J}=S({document:ve,options:{update:e=>{var n,o;e.evict({id:e.identify({__typename:"AIChat",id:w.value})});const t=(n=p.value)==null?void 0:n.findIndex(_=>_.id===w.value);t!==null&&((o=p.value)==null||o.splice(t,1))}},appApi:!0});function W(e){w.value=e,z({query:`ids:${e}`})}const V=async e=>{e.parentId===c.value&&(b.value+=e.content,g.value=await C(b.value+'<span class="blinking-cursor"></span>'),e.finishReason==="stop"&&T({id:c.value,message:b.value,isMe:!1}))};return oe(()=>{B.on("ai_chat_replied",V)}),ie(()=>{B.off("ai_chat_replied",V)}),(e,t)=>{const n=be,o=Ce,_=ge,D=me("tooltip");return l(),r("div",Me,[s("div",{class:"chat-items",ref_key:"scrollContainer",ref:I},[(l(!0),r(le,null,ce(p.value,(a,L)=>(l(),r("div",{key:a.id,class:"chat-item"},[O(a,L)?(l(),r("div",Ie,u(m(M)(a.createdAt)),1)):N("",!0),L>0?(l(),he(o,{key:1},{content:R(()=>[s("div",Ve,[s("md-menu-item",{onClick:Ee=>W(a.id),disabled:m(J)},[s("div",Le,u(e.$t("delete_message")),1)],8,De)])]),default:R(()=>[s("div",Te,[s("span",$e,u(e.$t(a.isMe?"me":"ai")),1),A((l(),r("span",xe,[K(u(m(q)(a.createdAt)),1)])),[[D,m(G)(a.createdAt)]]),Q(n,{class:"bi bi-more"})])]),_:2},1024)):(l(),r("div",Se,[s("span",He,u(e.$t(a.isMe?"me":"ai")),1),A((l(),r("span",Be,[K(u(m(q)(a.createdAt)),1)])),[[D,m(G)(a.createdAt)]])])),s("div",{class:"chat-content md-container",innerHTML:a.md},null,8,Ne)]))),128)),y.value?(l(),r("div",Qe,[s("div",Re,[s("span",Ge,u(e.$t("ai")),1)]),s("div",{class:"chat-content md-container",innerHTML:g.value},null,8,Ke)])):N("",!0)],512),s("div",qe,[A(s("md-outlined-text-field",{class:"textarea",type:"textarea","onUpdate:modelValue":t[0]||(t[0]=a=>i.value=a),autocomplete:"off",placeholder:e.$t("chat_input_hint"),onKeydown:[h(v($,["exact","prevent"]),["enter"]),t[1]||(t[1]=h(v(a=>i.value+=`
`,["shift","exact","prevent"]),["enter"])),t[2]||(t[2]=h(v(a=>i.value+=`
`,["ctrl","exact","prevent"]),["enter"])),t[3]||(t[3]=h(v(a=>i.value+=`
`,["alt","exact","prevent"]),["enter"])),t[4]||(t[4]=h(v(a=>i.value+=`
`,["meta","exact","prevent"]),["enter"]))]},null,40,Fe),[[de,i.value]]),s("div",Ue,[s("button",{class:"btn-icon",onClick:v($,["stop"])},[Pe,Q(_)])])])])}}}),ze=ke(je,[["__scopeId","data-v-4d4db71f"]]);export{ze as default};
